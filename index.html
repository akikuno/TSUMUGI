<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.2/cytoscape.min.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Cabin' rel='stylesheet'>

    <style>
        body {
            font-size: 18px;
            font-family: 'Cabin';
        }

        .container {
            display: flex;
            width: 100%;
            height: 1000px;
        }

        .cy-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .cy {
            flex: 1;
            height: calc(100% - 130px);
            /* カラースケールバーとテキストの高さを差し引いて設定 */
        }

        .tooltip {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            font-size: 20px;
            overflow-y: auto;
            border: 2px solid #333;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .color-scale-container {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }

        #color-scale {
            border: 1px solid #333;
        }

        .edge-scale-container {
            width: 100%;
            margin-top: 10px;
            text-align: center;
        }

        .scale-label {
            margin-top: 5px;
            font-size: 16px;
            font-family: 'Cabin';
            color: #333;
        }
    </style>
</head>

<body>
    <h1 style="text-align:center;">Phenotypic similarity gene network of 'Male Infertility'</h1>
    <p>Select Network layout:
        <select id="layout-dropdown" style="width: 10%; font-size: 20px;">
            <option value="cose" selected>Cose</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option>
            <option value="random">Random</option>
            <option value="concentric">Concentric</option>
        </select>
    </p>

    <div class="container">
        <div class="cy-container">
            <div class="cy"></div>
            <div class="color-scale-container">
                <canvas id="color-scale" width="400" height="30"></canvas>
                <p class="scale-label">Node color: Scaled effect size. Strength of the effect on the phenotype </p>
            </div>
            <div class="edge-scale-container">
                <canvas id="edge-scale" width="400" height="30"></canvas>
                <p class="scale-label">Edge size: Scaled number of shared phenotypes</p>
            </div>
        </div>
        <div class="tooltip"></div>
    </div>

    <script>
        const elements = [
            { data: { id: 'a', label: 'A', annotation: ['hoge', 'hooo'], node_size: 3 } },
            { data: { id: 'b', label: 'B', annotation: 'fuga', node_size: 10 } },
            { data: { id: 'c', label: 'C', annotation: 'foo', node_size: 1 } },
            { data: { source: 'a', target: 'b', annotation: 'Foo', edge_size: 0.5 } },
            { data: { source: 'a', target: 'c', annotation: 'FooBar', edge_size: 1.5 } },
        ];

        const nodeSizes = elements.filter(ele => ele.data.node_size !== undefined).map(ele => ele.data.node_size);
        const edgeSizes = elements.filter(ele => ele.data.edge_size !== undefined).map(ele => ele.data.edge_size);

        const nodeMin = Math.min(...nodeSizes);
        const nodeMax = Math.max(...nodeSizes);
        const edgeMin = Math.min(...edgeSizes);
        const edgeMax = Math.max(...edgeSizes);

        function scaleValue(value, minValue, maxValue, scaleMin, scaleMax) {
            return scaleMin + (value - minValue) * (scaleMax - scaleMin) / (maxValue - minValue);
        }

        function getColorForValue(value, minValue, maxValue) {
            const ratio = (value - minValue) / (maxValue - minValue);

            const r1 = 248, g1 = 229, b1 = 140;
            const r2 = 255, g2 = 140, b2 = 0;

            const r = Math.round(r1 + (r2 - r1) * ratio);
            const g = Math.round(g1 + (g2 - g1) * ratio);
            const b = Math.round(b1 + (b2 - b1) * ratio);

            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        elements.forEach(function (ele) {
            if (ele.data.node_size !== undefined) {
                ele.data.node_size = scaleValue(ele.data.node_size, nodeMin, nodeMax, 10, 30);
                ele.style = {
                    'background-color': getColorForValue(ele.data.node_size, 10, 30)
                };
            }
            if (ele.data.edge_size !== undefined) {
                ele.data.edge_size = scaleValue(ele.data.edge_size, edgeMin, edgeMax, 0.5, 2);
                ele.style = {
                    'line-color': 'gray',
                };
            }
        });

        const cy = cytoscape({
            container: document.querySelector('.cy'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-family': 'Cabin',
                        'width': 'data(node_size)',
                        'height': 'data(node_size)',
                        'font-size': function (ele) {
                            const size = ele.data('node_size');
                            return Math.max(8, size / 2) + 'px';
                        }
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'bezier',
                        'font-family': 'Cabin',
                        'text-rotation': 'autorotate',
                        'width': 'data(edge_size)',
                        'font-size': function (ele) {
                            const size = ele.data('edge_size');
                            return Math.max(8, size / 2) + 'px';
                        },
                    }
                }
            ],
            layout: { name: 'cose' }
        });

        document.getElementById('layout-dropdown').addEventListener('change', function () {
            const layout = this.value;
            cy.layout({ name: layout }).run();
        });

        cy.on('mouseover', 'node, edge', function (event) {
            const data = event.target.data();
            let tooltipText = '';

            if (event.target.isNode()) {
                const annotations = Array.isArray(data.annotation)
                    ? data.annotation.map(function (anno) { return '・ ' + anno; }).join('<br>')
                    : '・ ' + data.annotation;
                tooltipText = "<b>Phenotypes of " + data.label + " KO</b><br>" + annotations;
            } else if (event.target.isEdge()) {
                const sourceNode = cy.getElementById(data.source).data('label');
                const targetNode = cy.getElementById(data.target).data('label');
                const annotations = Array.isArray(data.annotation)
                    ? data.annotation.map(function (anno) { return '・ ' + anno; }).join('<br>')
                    : '・ ' + data.annotation;
                tooltipText = "<b>Shared phenotypes of " + sourceNode + " and " + targetNode + "</b><br>" + annotations;
            }

            document.querySelector('.tooltip').innerHTML = tooltipText;
        });

        function drawColorScale() {
            const canvas = document.getElementById('color-scale');
            const ctx = canvas.getContext('2d');

            const width = canvas.width;
            const height = canvas.height;

            const minValue = 0;
            const maxValue = 1;

            for (let i = 0; i < width; i++) {
                const value = minValue + (i / width) * (maxValue - minValue);
                const color = getColorForValue(value, minValue, maxValue);
                ctx.fillStyle = color;
                ctx.fillRect(i, 0, 1, height);
            }

            ctx.fillStyle = "#000";
            ctx.font = "12px Arial";
            ctx.fillText("Low", 0, height - 5);
            ctx.fillText("High", width - 30, height - 5);
        }

        function drawEdgeScale() {
            const canvas = document.getElementById('edge-scale');
            const ctx = canvas.getContext('2d');

            const width = canvas.width;
            const height = canvas.height;

            // 三角形の頂点と底辺の座標を設定
            const triangleHeight = height; // 三角形の高さ
            const triangleWidth = width; // 三角形の幅

            ctx.beginPath();
            ctx.moveTo(0, height - 15); // 左下の頂点
            ctx.lineTo(triangleWidth, height - 30); // 右上の頂点
            ctx.lineTo(triangleWidth, height); // 右下の頂点
            ctx.closePath();

            ctx.fillStyle = "gray"; // 三角形の色を灰色に設定
            ctx.fill();

            ctx.fillStyle = "#333";
            ctx.font = "12px Arial";
            ctx.fillText("Few", 0, height - 5);
            ctx.fillStyle = "#FFF";
            ctx.fillText("Many", width - 30, height - 5);
        }

        drawColorScale();
        drawEdgeScale();

    </script>
</body>

</html>
