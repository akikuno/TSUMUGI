<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.2/cytoscape.min.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Cabin' rel='stylesheet'>

    <style>
        body {
            font-size: 18px;
            font-family: 'Cabin';
        }

        .container {
            display: flex;
            width: 100%;
            height: 1000px;
        }

        .cy {
            flex: 3;
            /* 3 parts of the 3:1 ratio */
            height: 100%;
        }

        .tooltip {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            font-size: 20px;
            overflow-y: auto;
            border: 2px solid #333;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <h1 style="text-align:center;">Phenotypic similarity gene network of 'Male Infertility'</h1>
    <p>Select Network layout:
        <select id="layout-dropdown" style="width: 10%; font-size: 20px;">
            <option value="cose" selected>Cose</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option>
            <option value="random">Random</option>
            <option value="concentric">Concentric</option>
        </select>
    </p>

    <div class="container">
        <div class="cy"></div>
        <div class="tooltip">
        </div>
    </div>

    <script>

        const elements = [
            { data: { id: 'a', label: 'A', annotation: ['hoge', 'hooo'], node_size: 3 } },
            { data: { id: 'b', label: 'B', annotation: 'fuga', node_size: 10 } },
            { data: { id: 'c', label: 'C', annotation: 'foo', node_size: 1 } },
            { data: { source: 'a', target: 'b', annotation: 'Foo', edge_size: 0.5 } },
            { data: { source: 'a', target: 'c', annotation: 'FooBar', edge_size: 1.5 } },
        ];

        // ノードサイズとエッジサイズの最小値と最大値を見つける
        const nodeSizes = elements.filter(ele => ele.data.node_size !== undefined).map(ele => ele.data.node_size);
        const edgeSizes = elements.filter(ele => ele.data.edge_size !== undefined).map(ele => ele.data.edge_size);

        const nodeMin = Math.min(...nodeSizes);
        const nodeMax = Math.max(...nodeSizes);
        const edgeMin = Math.min(...edgeSizes);
        const edgeMax = Math.max(...edgeSizes);

        function scaleValue(value, minValue, maxValue, scaleMin, scaleMax) {
            return scaleMin + (value - minValue) * (scaleMax - scaleMin) / (maxValue - minValue);
        }

        function getColorForValue(value, minValue, maxValue) {
            const ratio = (value - minValue) / (maxValue - minValue);

            // 薄い黄色 (#f8e58c) の RGB 値
            const r1 = 248, g1 = 229, b1 = 140;

            // 濃いオレンジ (#FF8C00) の RGB 値
            const r2 = 255, g2 = 140, b2 = 0;

            // 各色成分を補間
            const r = Math.round(r1 + (r2 - r1) * ratio);
            const g = Math.round(g1 + (g2 - g1) * ratio);
            const b = Math.round(b1 + (b2 - b1) * ratio);

            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        // ノードサイズとエッジサイズをスケーリングし、色を設定する
        elements.forEach(function (ele) {
            if (ele.data.node_size !== undefined) {
                ele.data.node_size = scaleValue(ele.data.node_size, nodeMin, nodeMax, 10, 30);
                ele.style = {
                    'background-color': getColorForValue(ele.data.node_size, 10, 30)
                };
            }
            if (ele.data.edge_size !== undefined) {
                ele.data.edge_size = scaleValue(ele.data.edge_size, edgeMin, edgeMax, 0.5, 2);
            }
        });


        const cy = cytoscape({
            container: document.querySelector('.cy'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-family': 'Cabin',
                        'width': 'data(node_size)',
                        'height': 'data(node_size)',
                        'font-size': function (ele) {
                            const size = ele.data('node_size');
                            return Math.max(8, size / 2) + 'px';
                        }
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'bezier',
                        'font-family': 'Cabin',
                        'text-rotation': 'autorotate',
                        'width': 'data(edge_size)',
                        'font-size': function (ele) {
                            const size = ele.data('edge_size');
                            return Math.max(8, size / 2) + 'px';
                        },
                    }
                }
            ],
            layout: { name: 'cose' }  // Default layout
        });

        document.getElementById('layout-dropdown').addEventListener('change', function () {
            const layout = this.value;
            cy.layout({ name: layout }).run();
        });

        cy.on('mouseover', 'node, edge', function (event) {
            const data = event.target.data();
            let tooltipText = '';

            if (event.target.isNode()) {
                const annotations = Array.isArray(data.annotation)
                    ? data.annotation.map(function (anno) { return '・ ' + anno; }).join('<br>')
                    : '・ ' + data.annotation;
                tooltipText = "<b>Phenotypes of " + data.label + " KO</b><br>" + annotations;
            } else if (event.target.isEdge()) {
                const sourceNode = cy.getElementById(data.source).data('label');
                const targetNode = cy.getElementById(data.target).data('label');
                const annotations = Array.isArray(data.annotation)
                    ? data.annotation.map(function (anno) { return '・ ' + anno; }).join('<br>')
                    : '・ ' + data.annotation;
                tooltipText = "<b>Shared phenotypes of " + sourceNode + " and " + targetNode + " KOs</b><br>" + annotations;
            }

            document.querySelector('.tooltip').innerHTML = tooltipText;
        });

    </script>
</body>

</html>
