<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.2/cytoscape.min.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Cabin' rel='stylesheet'>

    <style>
        body {
            font-size: 18px;
            font-family: 'Cabin';
        }

        .container {
            display: flex;
            width: 100%;
            height: 1000px;
        }

        .cy-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .cy {
            flex: 1;
            height: calc(100% - 130px);
            /* カラースケールバーとテキストの高さを差し引いて設定 */
        }

        .tooltip {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            font-size: 20px;
            overflow-y: auto;
            border: 2px solid #333;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .color-scale-container {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }

        .edge-scale-container {
            width: 100%;
            margin-top: 10px;
            text-align: center;
        }

        .scale-label {
            margin-top: 5px;
            font-size: 16px;
            font-family: 'Cabin';
            color: #333;
        }
    </style>
</head>

<body>
    <h1 style="text-align:center;">Phenotypic similarity gene network of 'Male Infertility'</h1>
    <p>Select Network layout:
        <select id="layout-dropdown" style="width: 10%; font-size: 20px;">
            <option value="cose" selected>Cose</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option>
            <option value="random">Random</option>
            <option value="concentric">Concentric</option>
        </select>
    </p>

    <div class="container">

        <div class="cy-container">
            <div class="cy"></div>

            <!-- Colar scale and edge scale -->
            <div class="color-scale-container">
                <svg width="400" height="30" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="colorGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:rgb(248,229,140);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:rgb(255,140,0);stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect x="0" y="0" width="400" height="30" fill="url(#colorGradient)" />
                    <text x="0" y="25" font-family="Arial" font-size="12px" fill="#000">Low</text>
                    <text x="370" y="25" font-family="Arial" font-size="12px" fill="#000">High</text>
                </svg>
                <p class="scale-label">Node color: Scaled effect size. Strength of the effect on the phenotype </p>
            </div>
            <div class="edge-scale-container">
                <svg width="400" height="30" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="0,15 400,0 400,30" style="fill:gray;stroke:none;" />
                    <text x="0" y="25" font-family="Arial" font-size="12px" fill="#333">Few</text>
                    <text x="370" y="25" font-family="Arial" font-size="12px" fill="#FFF">Many</text>
                </svg>
                <p class="scale-label">Edge size: Scaled number of shared phenotypes</p>
            </div>
            <!-- Colar scale and edge scale -->

        </div>

        <div class="tooltip"></div>
    </div>

    <script>
        const elements = [
            { data: { id: 'a', label: 'A', annotation: ['hoge', 'hooo'], node_size: 3 } },
            { data: { id: 'b', label: 'B', annotation: 'fuga', node_size: 10 } },
            { data: { id: 'c', label: 'C', annotation: 'foo', node_size: 1 } },
            { data: { source: 'a', target: 'b', annotation: 'Foo', edge_size: 0.5 } },
            { data: { source: 'a', target: 'c', annotation: 'FooBar', edge_size: 1.5 } },
        ];

        const nodeSizes = elements.filter(ele => ele.data.node_size !== undefined).map(ele => ele.data.node_size);
        const edgeSizes = elements.filter(ele => ele.data.edge_size !== undefined).map(ele => ele.data.edge_size);

        const nodeMin = Math.min(...nodeSizes);
        const nodeMax = Math.max(...nodeSizes);
        const edgeMin = Math.min(...edgeSizes);
        const edgeMax = Math.max(...edgeSizes);

        function scaleValue(value, minValue, maxValue, scaleMin, scaleMax) {
            return scaleMin + (value - minValue) * (scaleMax - scaleMin) / (maxValue - minValue);
        }

        function getColorForValue(value, minValue, maxValue) {
            const ratio = (value - minValue) / (maxValue - minValue);

            const r1 = 248, g1 = 229, b1 = 140;
            const r2 = 255, g2 = 140, b2 = 0;

            const r = Math.round(r1 + (r2 - r1) * ratio);
            const g = Math.round(g1 + (g2 - g1) * ratio);
            const b = Math.round(b1 + (b2 - b1) * ratio);

            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        elements.forEach(function (ele) {
            if (ele.data.node_size !== undefined) {
                ele.data.node_size = scaleValue(ele.data.node_size, nodeMin, nodeMax, 10, 30);
                ele.style = {
                    'background-color': getColorForValue(ele.data.node_size, 10, 30)
                };
            }
            if (ele.data.edge_size !== undefined) {
                ele.data.edge_size = scaleValue(ele.data.edge_size, edgeMin, edgeMax, 0.5, 2);
                ele.style = {
                    'line-color': 'gray',
                };
            }
        });

        const cy = cytoscape({
            container: document.querySelector('.cy'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-family': 'Cabin',
                        'width': 'data(node_size)',
                        'height': 'data(node_size)',
                        'font-size': function (ele) {
                            const size = ele.data('node_size');
                            return Math.max(8, size / 2) + 'px';
                        }
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'bezier',
                        'font-family': 'Cabin',
                        'text-rotation': 'autorotate',
                        'width': 'data(edge_size)',
                        'font-size': function (ele) {
                            const size = ele.data('edge_size');
                            return Math.max(8, size / 2) + 'px';
                        },
                    }
                }
            ],
            layout: { name: 'cose' }
        });

        document.getElementById('layout-dropdown').addEventListener('change', function () {
            const layout = this.value;
            cy.layout({ name: layout }).run();
        });

        cy.on('mouseover', 'node, edge', function (event) {
            const data = event.target.data();
            let tooltipText = '';

            if (event.target.isNode()) {
                const annotations = Array.isArray(data.annotation)
                    ? data.annotation.map(function (anno) { return '・ ' + anno; }).join('<br>')
                    : '・ ' + data.annotation;
                tooltipText = "<b>Phenotypes of " + data.label + " KO</b><br>" + annotations;
            } else if (event.target.isEdge()) {
                const sourceNode = cy.getElementById(data.source).data('label');
                const targetNode = cy.getElementById(data.target).data('label');
                const annotations = Array.isArray(data.annotation)
                    ? data.annotation.map(function (anno) { return '・ ' + anno; }).join('<br>')
                    : '・ ' + data.annotation;
                tooltipText = "<b>Shared phenotypes of " + sourceNode + " and " + targetNode + "</b><br>" + annotations;
            }

            document.querySelector('.tooltip').innerHTML = tooltipText;
        });

    </script>
</body>

</html>
